---

# Role: UCX
# Install UCX

#
# UCX is necessary for building CUDA-aware OpenMPI
# UCX requires CUDA supporting GPU Direct (nvidia-peermem kernel module)
#

- name: install related packages
  apt:
    update_cache: yes
    name:
      - libfuse3-dev
      - libnuma-dev
      - binutils-dev

- name: make /opt/ucx
  file:
    path: /opt/ucx
    state: directory

- name: unarchive ucx-1.14.1.tar.gz
  unarchive:
    remote_src: yes
    src: https://github.com/openucx/ucx/releases/download/v1.14.1/ucx-1.14.1.tar.gz
    dest: /opt/ucx

# ./contrib/configure-release-mt --prefix=/usr/local/ucx-1.14.1 --with-cuda=/usr/local/cuda-11.8 --with-gdrcopy --enable-optimizations
- name: compile and install
  shell: |
    cd /opt/ucx/ucx-1.14.1
    ./contrib/configure-release-mt --prefix=/usr/local/ucx-1.14.1 --with-cuda=/usr/local/cuda-11.8 --enable-optimizations
     make -j
     make install

